<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Museum AR</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./style.css">
  
  <style>
    body {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      min-height: 100vh;
      color: white;
    }
    
    .admin-header {
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      z-index: 1050;
    }
    
    .admin-sidebar {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      min-height: calc(100vh - 76px);
    }
    
    .content-area {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      margin: 20px;
      padding: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      z-index: 1;
    }
    
    .nav-pills .nav-link {
      color: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      margin: 5px 0;
      transition: all 0.3s ease;
    }
    
    .nav-pills .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .nav-pills .nav-link.active {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
    }
    
    .table-dark {
      background: rgba(0, 0, 0, 0.3);
    }
    
    .btn-admin {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      border: none;
      color: white;
      transition: all 0.3s ease;
    }
    
    .btn-admin:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      color: white;
    }
    
    .stats-card {
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(78, 205, 196, 0.2));
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
    }
    
    /* Ensure dropdown menu appears on top */
    .dropdown-menu {
      z-index: 1060 !important;
      background: rgba(0, 0, 0, 0.9) !important;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
    }
    
    .dropdown-item {
      color: rgba(255, 255, 255, 0.9) !important;
    }
    
    .dropdown-item:hover {
      background: rgba(255, 255, 255, 0.1) !important;
      color: white !important;
    }
    
    /* Analytics specific styles */
    .user-journey-flow .journey-step .border {
      border-color: rgba(255, 255, 255, 0.2) !important;
      background: rgba(255, 255, 255, 0.05);
    }
    
    #artifactPopularityChart, #userEngagementChart, #deviceUsageChart {
      max-height: 300px;
    }
    
    .stats-card i {
      opacity: 0.8;
    }
    
    /* Artifact toggle switches */
    .form-switch .form-check-input:checked {
      background-color: #28a745;
      border-color: #28a745;
    }
    
    .card.artifact-disabled {
      opacity: 0.6;
      background: rgba(255, 255, 255, 0.05);
    }
    
    .toast-notification .alert {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>

  <!-- Admin Header -->
  <nav class="navbar navbar-expand-lg navbar-dark admin-header">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="fas fa-shield-alt me-2"></i>Museum AR - Admin Dashboard
      </a>
      <div class="navbar-nav ms-auto">
        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
            <img id="admin-avatar" src="https://ui-avatars.com/api/?name=Admin" alt="Admin" class="rounded-circle me-2" width="32" height="32">
            <span id="admin-name">Loading...</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" id="admin-profile"><i class="fas fa-user me-2"></i>Profile</a></li>
            <li><a class="dropdown-item" href="#" id="admin-settings"><i class="fas fa-cog me-2"></i>Settings</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="index.html"><i class="fas fa-eye me-2"></i>View as User</a></li>
            <li><a class="dropdown-item" href="#" id="admin-logout"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- Admin Sidebar -->
      <div class="col-md-3 col-lg-2 admin-sidebar p-3">
        <ul class="nav nav-pills flex-column" id="admin-nav">
          <li class="nav-item">
            <a class="nav-link active" href="#dashboard" data-tab="dashboard">
              <i class="fas fa-tachometer-alt me-2"></i>Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#users" data-tab="users">
              <i class="fas fa-users me-2"></i>User Management
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#ar-content" data-tab="ar-content">
              <i class="fas fa-cube me-2"></i>AR Content
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#analytics" data-tab="analytics">
              <i class="fas fa-chart-bar me-2"></i>Analytics
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#settings" data-tab="settings">
              <i class="fas fa-cogs me-2"></i>System Settings
            </a>
          </li>
        </ul>
      </div>

      <!-- Main Content Area -->
      <div class="col-md-9 col-lg-10">
        <div class="content-area">
          
          <!-- Dashboard Tab -->
          <div id="dashboard" class="tab-content active">
            <h2 class="mb-4"><i class="fas fa-tachometer-alt me-2"></i>Dashboard Overview</h2>
            
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="card stats-card text-center p-3">
                  <i class="fas fa-users fa-2x mb-2"></i>
                  <h4 id="total-users">0</h4>
                  <p class="mb-0">Total Users</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card stats-card text-center p-3">
                  <i class="fas fa-cube fa-2x mb-2"></i>
                  <h4 id="total-ar-content">5</h4>
                  <p class="mb-0">AR Content</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card stats-card text-center p-3">
                  <i class="fas fa-eye fa-2x mb-2"></i>
                  <h4 id="active-sessions">0</h4>
                  <p class="mb-0">Active Sessions</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card stats-card text-center p-3">
                  <i class="fas fa-chart-line fa-2x mb-2"></i>
                  <h4 id="total-views">0</h4>
                  <p class="mb-0">Total Views</p>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="card p-3">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Recent Activity</h5>
                    <button class="btn btn-outline-light btn-sm" onclick="refreshActivity()" title="Refresh Activity" id="activity-refresh-btn">
                      <i class="fas fa-sync-alt"></i>
                    </button>
                  </div>
                  <div id="recent-activity">
                    <p class="text-muted">Loading recent activity...</p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card p-3">
                  <h5><i class="fas fa-exclamation-triangle me-2"></i>System Status</h5>
                  <div class="mb-2">
                    <span class="badge bg-success me-2">●</span>Authentication Service
                  </div>
                  <div class="mb-2">
                    <span class="badge bg-success me-2">●</span>AR Content Delivery
                  </div>
                  <div class="mb-2">
                    <span class="badge bg-success me-2">●</span>Database Connection
                  </div>
                  <div class="mb-2">
                    <span class="badge bg-warning me-2">●</span>Text-to-Speech Service
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- User Management Tab -->
          <div id="users" class="tab-content" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-users me-2"></i>User Management</h2>
              <div>
                <button class="btn btn-outline-light me-2" onclick="loadUsersData()" title="Refresh Users">
                  <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
                <button class="btn btn-admin" data-bs-toggle="modal" data-bs-target="#addUserModal">
                  <i class="fas fa-plus me-2"></i>Add User
                </button>
              </div>
            </div>

            <div class="card">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-dark table-striped">
                    <thead>
                      <tr>
                        <th>Avatar</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="users-table-body">
                      <!-- Users will be loaded here -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- AR Content Tab -->
          <div id="ar-content" class="tab-content" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="fas fa-cube me-2"></i>AR Content Management</h2>
              <div>
                <button class="btn btn-outline-light me-2" onclick="refreshARContent()" title="Refresh AR Content">
                  <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
                <button class="btn btn-admin" data-bs-toggle="modal" data-bs-target="#addContentModal">
                  <i class="fas fa-plus me-2"></i>Add AR Content
                </button>
              </div>
            </div>

            <div class="row" id="ar-content-grid">
              <!-- AR Content cards will be loaded here -->
            </div>
          </div>

          <!-- Analytics Tab -->
          <div id="analytics" class="tab-content" style="display: none;">
            <h2 class="mb-4"><i class="fas fa-chart-bar me-2"></i>Analytics & Reports</h2>
            
            <!-- Engagement Overview Cards -->
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="card stats-card text-center p-3">
                  <i class="fas fa-eye fa-2x mb-2 text-info"></i>
                  <h4 id="total-artifact-views">0</h4>
                  <p class="mb-0">Artifact Views</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card stats-card text-center p-3">
                  <i class="fas fa-clock fa-2x mb-2 text-success"></i>
                  <h4 id="avg-session-time">0m</h4>
                  <p class="mb-0">Avg Session Time</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card stats-card text-center p-3">
                  <i class="fas fa-volume-up fa-2x mb-2 text-warning"></i>
                  <h4 id="tts-usage">0</h4>
                  <p class="mb-0">TTS Interactions</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card stats-card text-center p-3">
                  <i class="fas fa-mobile-alt fa-2x mb-2 text-primary"></i>
                  <h4 id="mobile-users">0%</h4>
                  <p class="mb-0">Mobile Users</p>
                </div>
              </div>
            </div>

            <!-- Charts Row -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card p-3">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-dinosaur me-2"></i>Artifact Popularity</h5>
                    <button class="btn btn-outline-light btn-sm" onclick="refreshAnalytics()" title="Refresh Analytics">
                      <i class="fas fa-sync-alt"></i>
                    </button>
                  </div>
                  <canvas id="artifactPopularityChart" height="200"></canvas>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card p-3">
                  <h5 class="mb-3"><i class="fas fa-users me-2"></i>User Engagement Over Time</h5>
                  <canvas id="userEngagementChart" height="200"></canvas>
                </div>
              </div>
            </div>

            <!-- Detailed Analytics Tables -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card p-3">
                  <h5 class="mb-3"><i class="fas fa-trophy me-2"></i>Top Artifacts</h5>
                  <div class="table-responsive">
                    <table class="table table-dark table-sm">
                      <thead>
                        <tr>
                          <th>Artifact</th>
                          <th>Views</th>
                          <th>Avg Time</th>
                          <th>TTS Usage</th>
                        </tr>
                      </thead>
                      <tbody id="top-artifacts-table">
                        <!-- Data will be loaded here -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card p-3">
                  <h5 class="mb-3"><i class="fas fa-calendar-day me-2"></i>Daily Engagement</h5>
                  <div class="table-responsive">
                    <table class="table table-dark table-sm">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Unique Users</th>
                          <th>Total Views</th>
                          <th>Sessions</th>
                        </tr>
                      </thead>
                      <tbody id="daily-engagement-table">
                        <!-- Data will be loaded here -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- User Behavior Analysis -->
            <div class="row">
              <div class="col-md-8">
                <div class="card p-3">
                  <h5 class="mb-3"><i class="fas fa-route me-2"></i>User Journey Analysis</h5>
                  <div id="user-journey-analysis">
                    <!-- Journey data will be loaded here -->
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card p-3">
                  <h5 class="mb-3"><i class="fas fa-device-mobile me-2"></i>Device Usage</h5>
                  <canvas id="deviceUsageChart" height="250"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Settings Tab -->
          <div id="settings" class="tab-content" style="display: none;">
            <h2 class="mb-4"><i class="fas fa-cogs me-2"></i>System Settings</h2>
            
            <div class="card">
              <div class="card-body">
                <form id="system-settings-form">
                  <div class="mb-3">
                    <label class="form-label">Museum Name</label>
                    <input type="text" class="form-control" id="museum-name" value="Museum AR Experience">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Maximum Users</label>
                    <input type="number" class="form-control" id="max-users" value="1000">
                  </div>
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="email-verification" checked>
                      <label class="form-check-label">Require Email Verification</label>
                    </div>
                  </div>
                  <div class="mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="auto-speech" checked>
                      <label class="form-check-label">Enable Auto Text-to-Speech</label>
                    </div>
                  </div>
                  <button type="submit" class="btn btn-admin">
                    <i class="fas fa-save me-2"></i>Save Settings
                  </button>
                </form>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Add User Modal -->
  <div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title">Add New User</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="add-user-form">
            <div class="mb-3">
              <label class="form-label">Full Name</label>
              <input type="text" class="form-control" id="new-user-name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="new-user-email" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Role</label>
              <select class="form-select" id="new-user-role">
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Temporary Password</label>
              <input type="password" class="form-control" id="new-user-password" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-admin" id="create-user-btn">Create User</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add AR Content Modal -->
  <div class="modal fade" id="addContentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content bg-dark text-white">
        <div class="modal-header">
          <h5 class="modal-title">Add AR Content</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="add-content-form">
            <div class="mb-3">
              <label class="form-label">Content Name</label>
              <input type="text" class="form-control" id="content-name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="content-description" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">QR Code Image</label>
              <input type="file" class="form-control" id="qr-code-file" accept="image/*">
            </div>
            <div class="mb-3">
              <label class="form-label">AR Model/Content</label>
              <input type="file" class="form-control" id="ar-content-file">
            </div>
            <div class="mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="content-active" checked>
                <label class="form-check-label">Active</label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-admin" id="create-content-btn">Add Content</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer">
    <!-- Toasts will be inserted here dynamically -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="app.js"></script>
  <script type="module" src="email-verification-guard.js"></script>
  <script type="module" src="admin.js"></script>
  
  <!-- User Details Display Script -->
  <script type="module">
    import { auth } from './app.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', () => {
      // Listen for authentication state changes
      onAuthStateChanged(auth, (user) => {
        if (user && user.emailVerified) {
          updateUserDisplay(user);
        } else {
          // Fallback if no user or not verified
          document.getElementById('admin-name').textContent = 'Admin User';
        }
      });
    });
    
    function updateUserDisplay(user) {
      const adminName = document.getElementById('admin-name');
      const adminAvatar = document.getElementById('admin-avatar');
      
      if (adminName && adminAvatar) {
        // Extract user's name from email or display name
        const displayName = user.displayName || user.email.split('@')[0];
        const userEmail = user.email;
        
        // Update the display name
        adminName.textContent = displayName;
        
        // Update avatar using the user's email for UI Avatars
        const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=random&color=fff&size=32`;
        adminAvatar.src = avatarUrl;
        adminAvatar.alt = displayName;
        
        // Add email to the dropdown title for reference
        adminName.title = userEmail;
        
        console.log('✅ Admin user display updated:', {
          displayName: displayName,
          email: userEmail
        });
      }
    }
  </script>
</body>
</html>
